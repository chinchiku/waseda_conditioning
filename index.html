<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ワセダ_覇者への道のり (v53)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Klee+One:wght@600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- ★ v50: Google API & Sign-In (GSI) - onload="" を削除 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                        klee: ['"Klee One"', 'serif'],
                    },
                    colors: {
                        waseda: {
                            DEFAULT: '#990000', // 臙脂 (濃い)
                            dark: '#660000',
                            light: '#CC0000',
                            lighter: '#FFCCCC',
                            bg: '#FFFBFB' // ほんのり赤みのある背景
                        }
                    }
                },
            },
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .page-content { display: none; }
        #page-dashboard { display: block; }
        
        h1, h2, h3, h4, h5, h6 {
            @apply font-klee;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-800 text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #990000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .plan-table {
            @apply w-full min-w-full divide-y divide-gray-200;
        }
        .plan-table th {
            @apply px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .plan-table td {
            @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700;
        }
        
        details > summary {
            list-style: none; 
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none; 
        }
        details > summary::after {
            content: '▼'; 
            float: right;
            transition: transform 0.2s;
        }
        details[open] > summary::after {
            transform: rotate(180deg); 
        }
        
        .plan-button {
            @apply p-2 rounded-lg transition-colors duration-200;
        }
        .plan-button:hover {
            @apply bg-gray-200;
        }
    </style>
    
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    
    <div class="min-h-screen flex flex-col md:flex-row">

        <!-- サイド ナビゲーションバー (★ v51: ボタンを disabled に) -->
        <nav class="bg-white shadow-lg md:w-64 flex-shrink-0 flex flex-col">
            <!-- ヘッダー -->
            <div class="flex justify-between items-center p-4 md:pt-8 md:px-6">
                <h1 class="text-xl md:text-2xl font-bold text-red-800">ワセダ_覇者への道のり</h1>
                <button id="mobile-menu-button" class="text-gray-600 focus:outline-none md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
            
            <!-- ナビゲーション (PC用 / モバイル用メニュー) -->
            <div id="nav-content" class="hidden md:flex md:flex-col md:flex-grow md:mt-8">
                <ul class="space-y-2 px-4">
                    <li>
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-red-50 hover:text-red-800" data-page="page-settings">
                            <span class="mr-3">⚙️</span> 設定
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-red-50 hover:text-red-800" data-page="page-dashboard">
                            <span class="mr-3">📊</span> ダッシュボード
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-red-50 hover:text-red-800" data-page="page-condition">
                            <span class="mr-3">📈</span> コンディション
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-red-50 hover:text-red-800" data-page="page-tapering">
                            <span class="mr-3">🗓️</span> テーパリング
                        </a>
                    </li>
                </ul>
                
                <!-- ★ v51: サインイン/アウト ボタン (デフォルトで disabled) -->
                <div class="mt-auto p-4">
                    <button id="google-auth-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Google サインイン
                    </button>
                    <div id="google-auth-status" class="text-xs text-gray-500 mt-2 text-center"></div>
                </div>
            </div>
        </nav>

        <!-- メインコンテンツ -->
        <main class="flex-grow p-6 md:p-10 overflow-auto">
            
            <!-- 1. ダッシュボード ページ (v44と同じ) -->
            <div id="page-dashboard" class="page-content">
                <h2 class="text-3xl font-semibold mb-6">ダッシュボード</h2>

                <!-- 使い方マニュアル (v44と同じ) -->
                <details class="bg-white p-6 rounded-2xl shadow-lg mb-8 border-l-4 border-red-800">
                    <summary class="text-xl font-semibold text-gray-800">はじめに (使い方マニュアル)</summary>
                    <div class="mt-4 pt-4 border-t border-gray-200 text-gray-700 space-y-3 text-sm">
                        <p>このアプリは、日々の練習日誌データ（CSVまたは手動入力）を読み込み、コンディションやテーパリング計画を管理するためのツールです。</p>
                        <ol class="list-decimal list-inside space-y-2">
                            <li>
                                <strong class="font-semibold text-gray-800">[設定] ページ (最重要):</strong>
                                <ul class="list-disc list-inside ml-4 mt-1">
                                    <li>最初に、このページでデータ入力方法（Google連携 or 手動）を選択します。</li>
                                    <li><strong class="font-semibold text-red-800">Google連携:</strong> 「クライアントID」「スプレッドシートID」「シート名(タブ名)」の入力が必要です。入力後、左下の「Google サインイン」ボタンを押してください。</li>
                                    <li><strong class="font-semibold text-red-800">手動入力:</strong> 走行距離データを「日付,距離」の形式で貼り付けます。</li>
                                    <li>最後に必ず「設定を保存」ボタンを押してください。データは保存後にリロードすると反映されます。</li>
                                </ul>
                            </li>
                            <li>
                                <strong class="font-semibold text-gray-800">[ダッシュボード] ページ:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1">
                                    <li>読み込んだデータの「最新値」「前日比」「直近7日間平均」を一覧表示します。</li>
                                </ul>
                            </li>
                            <li>
                                <strong class="font-semibold text-gray-800">[コンディション] ページ:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1">
                                    <li>データの推移をグラフで視覚化します。チェックボックスで表示項目を切り替えられます。</li>
                                </ul>
                            </li>
                            <li>
                                <strong class="font-semibold text-gray-800">[テーパリング] ページ:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1">
                                    <li>レース日と期間から、推奨される走行距離の減衰計画を自動で計算し、保存・管理できます。</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </details>
                
                <div id="dashboard-loading" class="flex flex-col items-center justify-center h-64">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600">データを読み込み中...</p>
                </div>

                <!-- (v44と同じ) -->
                <div id="dashboard-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">データ取得エラー</strong>
                    <span class="block sm:inline" id="dashboard-error-message"></span>
                </div>
                <div id="dashboard-warning" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">警告</strong>
                    <span class="block sm:inline" id="dashboard-warning-message"></span>
                </div>


                <!-- 上段3つ (v44と同じ) -->
                <div id="dashboard-summary-top" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- 走行距離カード -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">走行距離</h3>
                        <p id="summary-distance" class="text-4xl font-bold text-blue-600">– <span class="text-lg font-medium text-gray-500">km</span></p>
                        <p id="avg-distance" class="text-sm text-gray-500 mt-1">週平均: – km/日</p>
                        <div id="summary-distance-change" class="mt-2 text-sm text-gray-500 h-5">
                            <span>–</span> (<span>–</span>)
                        </div>
                    </div>
                    <!-- 朝体重カード -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">朝体重</h3>
                        <p id="summary-morning-weight" class="text-4xl font-bold text-green-600">– <span class="text-lg font-medium text-gray-500">kg</span></p>
                        <p id="avg-morning-weight" class="text-sm text-gray-500 mt-1">週平均: – kg</p>
                        <div id="summary-morning-weight-change" class="mt-2 text-sm text-gray-500 h-5">
                            <span>–</span> (<span>–</span>)
                        </div>
                    </div>
                    <!-- 夜体重カード -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">夜体重</h3>
                        <p id="summary-evening-weight" class="text-4xl font-bold text-emerald-600">– <span class="text-lg font-medium text-gray-500">kg</span></p>
                        <p id="avg-evening-weight" class="text-sm text-gray-500 mt-1">週平均: – kg</p>
                        <div id="summary-evening-weight-change" class="mt-2 text-sm text-gray-500 h-5">
                            <span>–</span> (<span>–</span>)
                        </div>
                    </div>
                </div>
                <!-- 下段2つ (v44と同じ) -->
                <div id="dashboard-summary-bottom" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6">
                     <!-- 起床時脈拍カード -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">起床時脈拍</h3>
                        <p id="summary-waking-hr" class="text-4xl font-bold text-red-600">– <span class="text-lg font-medium text-gray-500">bpm</span></p>
                        <p id="avg-waking-hr" class="text-sm text-gray-500 mt-1">週平均: – bpm</p>
                        <div id="summary-waking-hr-change" class="mt-2 text-sm text-gray-500 h-5">
                            <span>–</span> (<span>–</span>)
                        </div>
                    </div>
                    <!-- 睡眠時間カード -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">睡眠時間</h3>
                        <p id="summary-sleep" class="text-4xl font-bold text-purple-600">– <span class="text-lg font-medium text-gray-500">時間</span></p>
                        <p id="avg-sleep" class="text-sm text-gray-500 mt-1">週平均: – 時間</p>
                        <div id="summary-sleep-change" class="mt-2 text-sm text-gray-500 h-5">
                            <span>–</span> (<span>–</span>)
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- 2. コンディション記録 ページ (v44と同じ) -->
            <div id="page-condition" class="page-content">
                <h2 class="text-3xl font-semibold mb-6">コンディション記録</h2>
                
                <!-- グラフ表示切り替え -->
                <div id="chart-controls" class="bg-white p-4 rounded-2xl shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                    <h4 class="text-lg font-semibold text-gray-700 mr-4">表示項目:</h4>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="toggle-distance" class="chart-toggle form-checkbox text-red-800 rounded focus:ring-red-700" data-dataset-index="0">
                        <span class="text-gray-700">走行距離</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="toggle-morning-weight" class="chart-toggle form-checkbox text-red-800 rounded focus:ring-red-700" data-dataset-index="1" checked>
                        <span class="text-gray-700">朝体重</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="toggle-evening-weight" class="chart-toggle form-checkbox text-red-800 rounded focus:ring-red-700" data-dataset-index="2">
                        <span class="text-gray-700">夕体重</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="toggle-waking-hr" class="chart-toggle form-checkbox text-red-800 rounded focus:ring-red-700" data-dataset-index="3" checked>
                        <span class="text-gray-700">起床時脈拍</span>
                    </label>
                </div>
                
                <!-- 週平均表示エリア (v44と同じ) -->
                <div id="chart-averages" class="bg-white p-4 rounded-2xl shadow-lg mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">直近7日間平均</h4>
                    <div id="chart-averages-content" class="flex flex-wrap gap-x-6 gap-y-2 text-gray-600">
                        <p>（グラフの表示項目を選択してください）</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">コンディションの推移</h3>
                    <div class="w-full" style="height: 400px;">
                        <canvas id="conditionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 3. テーパリング計画 ページ (v44と同じ) -->
            <div id="page-tapering" class="page-content">
                <h2 class="text-3xl font-semibold mb-6">テーパリング計画</h2>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    
                    <!-- テーパリングの原則 (v44と同じ) -->
                    <div class="mb-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">テーパリングの原則</h3>
                        <div class="space-y-2 text-gray-700">
                            <ul class="list-disc list-inside space-y-1">
                                <li><strong>強度</strong> &rarr; 維持</li>
                                <li><strong>量</strong> &rarr; 40-60%減らす</li>
                                <li><strong>頻度</strong> &rarr; 維持（80%程度）</li>
                            </ul>
                            <div class="mt-3 pt-3 border-t border-yellow-200">
                                <p class="font-semibold text-gray-800">💡 ポイント：</p>
                                <ul class="list-disc list-inside space-y-1 mt-1 text-sm">
                                    <li>練習が積めていない &rarr; 期間を短く、最終負荷を大きく</li>
                                    <li>試合の距離が短い &rarr; 期間を短く</li>
                                    <li>疲労が抜けにくい &rarr; 最終負荷を小さく</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 「保存された計画」セクション (v44と同じ) -->
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">保存された計画</h3>
                    <div id="saved-plans-list" class="space-y-3 mb-6">
                        <!-- JSによって計画がここに追加されます -->
                        <p class="text-gray-500 text-sm">保存された計画はまだありません。</p>
                    </div>

                    <!-- 新規計画ボタン (v44と同じ) -->
                    <div class="mb-6">
                         <button id="new-plan-button" class="bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 w-full md:w-auto">
                            新規テーパリング計画を作成
                        </button>
                    </div>

                    <!-- 新規/編集フォーム (v44と同じ) -->
                    <div id="plan-form-container" class="hidden mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 id="plan-form-title" class="text-xl font-semibold text-gray-800 mb-6">新規計画</h3>
                        
                        <input type="hidden" id="plan-edit-id" value="">
                        
                        <!-- (v44と同じ) -->
                        <div id="plan-form-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4" role="alert"></div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- レース名 -->
                            <div>
                                <label for="plan-race-name" class="form-label font-bold">レース名</label>
                                <input type="text" id="plan-race-name" class="form-input" placeholder="例: ○○駅伝">
                            </div>
                            <!-- レース日 -->
                            <div>
                                <label for="plan-race-date" class="form-label font-bold">レース日</label>
                                <input type
